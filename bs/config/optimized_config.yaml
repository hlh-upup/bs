# AI生成说话人脸视频评价模型优化配置文件
# 基于专家分析结果优化，解决数据质量问题

# 数据配置
data:
  dataset: "EmotionTalk"
  dataset_path: "datasets/ac_processed.pkl"  # 更新为处理后数据集
  train_split: 0.8
  val_split: 0.1
  test_split: 0.1
  batch_size: 2  # 从1提升到2，配合梯度累积
  num_workers: 0
  max_frames: 150
  frame_rate: 25
  audio_sample_rate: 16000
  face_size: 96

# 数据预处理配置
preprocessing:
  feature_scaling: true
  scaling_method: "standard"  # 标准化处理
  nan_handling: "impute"      # 缺失值插补
  outlier_detection: true
  feature_selection: true
  pca_components:
    keypoint: 50    # 从1404降至50维
    visual: 100     # 从163降至100维
    audio: 200      # 从768降至200维
    au: 17          # 保持17维

# 特征提取配置
feature_extraction:
  feature_types: ['visual', 'audio', 'keypoint', 'au', 'syncnet']
  
# 模型配置
model:
  name: "OptimizedMTLTalkingFaceEvaluator"
  # 降维后的特征维度
  visual_dim: 100      # 从163降至100
  audio_dim: 200       # 从768降至200  
  keypoint_dim: 50     # 从1404降至50
  au_dim: 17           # 保持17
  encoder_dim: 512     # 从256提升至512
  hidden_dim: 512      # 从256提升至512
  dropout: 0.3
  
  # Transformer优化
  transformer:
    num_layers: 6      # 从3提升至6
    num_heads: 16      # 从8提升至16
    dim_feedforward: 2048  # 从1024提升至2048
    dropout: 0.1
  
  # 任务权重优化
  task_weights:
    lip_sync: 0.8      # 表现好，降低权重
    expression: 1.2    # 提升权重
    audio_quality: 1.0
    cross_modal: 1.5   # 重点优化，最高权重
    overall: 1.3

  # 高级模型专用配置 (可选)
  advanced:
    task_weighting: "uncertainty"   # 可选: learned | uncertainty | gradnorm
    consistency:
      mode: "corr"                  # 可选: std | corr | cov
      weight: 0.1                   # 一致性损失权重
      tasks: ["lip_sync", "expression", "audio_quality", "cross_modal"]
  # 任务头（隐藏层维度等，可覆盖默认）
  task_heads:
    lip_sync:
      hidden_dims: [256, 128]
      dropout: 0.3
    expression:
      hidden_dims: [256, 128]
      dropout: 0.3
    audio_quality:
      hidden_dims: [256, 128]
      dropout: 0.3
    cross_modal:
      hidden_dims: [256, 128]
      dropout: 0.3
    overall:
      hidden_dims: [256, 128]
      dropout: 0.2

# 训练优化配置  
train:
  epochs: 150          # 从100提升至150
  output_dir: "../experiments_optimized"
  save_dir: "../experiments_optimized"
  log_dir: "../experiments_optimized/logs"
  save_interval: 5     # 从10降至5，更频繁保存
  
  # 优化器改进
  optimizer:
    type: "adamw"      # 从adam改为adamw
    lr: 0.001          # 从0.0001提升至0.001
    weight_decay: 0.01  # 从0.0001提升至0.01
    
  # 学习率调度优化
  scheduler:
    type: "cosine_with_warmup"  # 添加warmup
    warmup_steps: 500
    T_max: 150
    eta_min: 1e-6
    
  # 训练稳定性
  early_stopping: 15   # 从10提升至15
  gradient_accumulation: 8  # 从4提升至8
  gradient_clipping: 1.0    # 新增梯度裁剪
  mixed_precision: true
  
  # 正则化
  label_smoothing: 0.1
  
# 评估配置
eval:
  metrics: ["pearson", "spearman", "rmse", "mae", "r2"]
  visualization: true
  eval_interval: 5     # 每5轮评估一次

# 新增监控配置
monitoring:
  log_memory: true
  log_gradients: true
  track_feature_stats: true